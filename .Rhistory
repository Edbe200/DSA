# Load functions and packages
source("scripts/dsa.R")
setwd("C:/Users/edwar/Desktop/DSA")
# Load functions and packages
source("scripts/dsa.R")
source("scripts/tornado.R")
library(readxl)
# Import transition probabilities
m_TP <- read_excel("data/inputs/transition_probabilities.xlsx") |>
as.data.frame() |>
tibble::column_to_rownames(var = "HS") |>
as.matrix()
# Define parameters
v_init_state <- c(H = 1, S1 = 0, S2 = 0, R = 0, D = 0)
v_utilities <- c(H = 1, S1 = 0.75, S2 = 0.5, R = 0.9, D = 0)
v_costs <- c(H = 0, S1 = 4000, S2 = 15000, R = 0, D = 0)
n_cycles <- 31
r <- 0.03
# Define treatments
trt_standard <- list(
name = "Standard Care",
transitions = list("S1_S2" = 0.8, "S1_D" = 0.8, "S2_D" = 0.8),
cost = 3000,
apply_states = c("S1", "S2")
)
trt_advanced <- list(
name = "Advanced Therapy",
transitions = list("S1_S2" = 0.5, "S1_D" = 0.5, "S2_D" = 0.5),
cost = 8000,
apply_states = c("S1", "S2")
)
# Package base parameters
base_params <- list(
v_utilities = v_utilities,
v_costs = v_costs,
trt_standard = trt_standard,
trt_advanced = trt_advanced,
r = r
)
# Run deterministic sensitivity analysis
dsa_params <- read_excel("data/inputs/dsa_parameters.xlsx")
dsa_results <- run_owsa(
m_TP, v_init_state, n_cycles, base_params, dsa_params,
strategy1 = "Baseline",
strategy2 = "Standard Care"
)
# Calculate base case ICER and create tornado plot
base_icer <- run_comparison(m_TP, v_init_state, n_cycles, base_params,
"Baseline", "Standard Care")$icer
tornado_plot <- plot_tornado(dsa_results, base_icer, wtp = 20000)
print(tornado_plot)
ggsave("data/outputs/tornado_diagram.png", tornado_plot, width = 10, height = 8, dpi = 300)
View(dsa_results)
# Load functions and packages
source("scripts/dsa.R")
source("scripts/tornado.R")
library(readxl)
# Import transition probabilities
m_TP <- read_excel("data/inputs/transition_probabilities.xlsx") |>
as.data.frame() |>
tibble::column_to_rownames(var = "HS") |>
as.matrix()
# Define parameters
v_init_state <- c(H = 1, S1 = 0, S2 = 0, R = 0, D = 0)
n_cycles <- 31
base_params <- list(
v_utilities = c(H = 1, S1 = 0.75, S2 = 0.5, R = 0.9, D = 0),
v_costs = c(H = 0, S1 = 4000, S2 = 15000, R = 0, D = 0),
trt_standard = list(
name = "Standard Care",
transitions = list("S1_S2" = 0.8, "S1_D" = 0.8, "S2_D" = 0.8),
cost = 3000,
apply_states = c("S1", "S2")
),
trt_advanced = list(
name = "Advanced Therapy",
transitions = list("S1_S2" = 0.5, "S1_D" = 0.5, "S2_D" = 0.5),
cost = 8000,
apply_states = c("S1", "S2")
),
r = 0.03
)
# Run deterministic sensitivity analysis
dsa_params <- read_excel("data/inputs/dsa_parameters.xlsx")
dsa_results <- run_owsa(
m_TP, v_init_state, n_cycles, base_params, dsa_params,
strategy1 = "Baseline",
strategy2 = "Standard Care"
)
# Calculate base case ICER and create tornado plot
base_icer <- run_comparison(m_TP, v_init_state, n_cycles, base_params,
"Baseline", "Standard Care")$icer
tornado_plot <- plot_tornado(dsa_results, base_icer, wtp = 20000)
print(tornado_plot)
ggsave("data/outputs/tornado_diagram.png", tornado_plot, width = 10, height = 8, dpi = 300)
View(dsa_params)
View(base_params)
View(dsa_params)
# Load functions and packages
source("scripts/dsa.R")
source("scripts/tornado.R")
library(readxl)
# Import transition probabilities and DSA parameters
m_TP <- read_excel("data/inputs/transition_probabilities.xlsx") |>
as.data.frame() |>
tibble::column_to_rownames(var = "HS") |>
as.matrix()
dsa_params <- read_excel("data/inputs/dsa_parameters.xlsx")
# Define parameters
v_init_state <- c(H = 1, S1 = 0, S2 = 0, R = 0, D = 0)
n_cycles <- 31
base_params <- list(
v_utilities = c(H = 1, S1 = 0.75, S2 = 0.5, R = 0.9, D = 0),
v_costs = c(H = 0, S1 = 4000, S2 = 15000, R = 0, D = 0),
trt_standard = list(
name = "Standard Care",
transitions = list("S1_S2" = 0.8, "S1_D" = 0.8, "S2_D" = 0.8),
cost = 3000,
apply_states = c("S1", "S2")
),
trt_advanced = list(
name = "Advanced Therapy",
transitions = list("S1_S2" = 0.5, "S1_D" = 0.5, "S2_D" = 0.5),
cost = 8000,
apply_states = c("S1", "S2")
),
r = 0.03
)
# Run deterministic sensitivity analysis
dsa_results <- run_owsa(
m_TP, v_init_state, n_cycles, base_params, dsa_params,
strategy1 = "Baseline",
strategy2 = "Standard Care"
)
# Calculate base case ICER and create tornado plot
base_icer <- run_comparison(m_TP, v_init_state, n_cycles, base_params,
"Baseline", "Standard Care")$icer
tornado_plot <- plot_tornado(dsa_results, base_icer, wtp = 20000)
print(tornado_plot)
ggsave("data/outputs/tornado_diagram.png", tornado_plot, width = 10, height = 8, dpi = 300)
# Load functions and packages
source("scripts/dsa.R")
source("scripts/tornado.R")
library(readxl)
# Import transition probabilities and DSA parameters
m_TP <- read_excel("data/inputs/transition_probabilities.xlsx") |>
as.data.frame() |>
tibble::column_to_rownames(var = "HS") |>
as.matrix()
dsa_params <- read_excel("data/inputs/dsa_parameters.xlsx")
# Define basic parameters
v_init_state <- c(H = 1, S1 = 0, S2 = 0, R = 0, D = 0)
n_cycles <- 31
# Build base_params from dsa_params (single source of truth)
get_param <- function(name) {
dsa_params$base_value[dsa_params$parameter == name]
}
base_params <- list(
v_utilities = c(H = get_param("u_H"), S1 = get_param("u_S1"),
S2 = get_param("u_S2"), R = get_param("u_R"), D = 0),
v_costs = c(H = 0, S1 = get_param("c_S1"), S2 = get_param("c_S2"), R = 0, D = 0),
trt_standard = list(
name = "Standard Care",
transitions = list(
"S1_S2" = get_param("rr_S1_S2_standard"),
"S1_D" = get_param("rr_S1_D_standard"),
"S2_D" = get_param("rr_S2_D_standard")
),
cost = get_param("c_trt_standard"),
apply_states = c("S1", "S2")
),
trt_advanced = list(
name = "Advanced Therapy",
transitions = list(
"S1_S2" = get_param("rr_S1_S2_advanced"),
"S1_D" = get_param("rr_S1_D_advanced"),
"S2_D" = get_param("rr_S2_D_advanced")
),
cost = get_param("c_trt_advanced"),
apply_states = c("S1", "S2")
),
r = get_param("discount_rate")
)
# Run deterministic sensitivity analysis
dsa_results <- run_owsa(
m_TP, v_init_state, n_cycles, base_params, dsa_params,
strategy1 = "Baseline",
strategy2 = "Standard Care"
)
# Calculate base case ICER and create tornado plot
base_icer <- run_comparison(m_TP, v_init_state, n_cycles, base_params,
"Baseline", "Standard Care")$icer
tornado_plot <- plot_tornado(dsa_results, base_icer, wtp = 20000)
print(tornado_plot)
ggsave("data/outputs/tornado_diagram.png", tornado_plot, width = 10, height = 8, dpi = 300)
View(dsa_params)
shiny::runApp()
runApp()
runApp()
runApp()
runApp()
runApp()
runApp()
runApp()
shiny::runApp()
# Create tornado diagram for one-way sensitivity analysis
plot_tornado <- function(dsa_results, base_case_icer, wtp = NULL) {
library(ggplot2)
# Calculate parameter ranges and order by impact
param_ranges <- aggregate(icer ~ parameter, data = dsa_results,
function(x) max(x, na.rm = TRUE) - min(x, na.rm = TRUE))
colnames(param_ranges)[2] <- "range"
param_ranges <- param_ranges[order(-param_ranges$range), ]
# Merge and set factor levels
plot_data <- merge(dsa_results, param_ranges, by = "parameter")
plot_data$parameter <- factor(plot_data$parameter, levels = rev(param_ranges$parameter))
# Create plot
ggplot(plot_data, aes(x = icer, y = parameter)) +
geom_line(aes(group = parameter), linewidth = 1.5, color = "steelblue") +
geom_point(aes(shape = bound), size = 3, color = "steelblue") +
geom_vline(xintercept = base_case_icer, linetype = "dashed") +
geom_vline(xintercept = wtp, linetype = "dotted", color = "red") +
scale_shape_manual(values = c("lower" = 16, "upper" = 17)) +
labs(
title = "Tornado Diagram: One-Way Sensitivity Analysis",
subtitle = paste0("Base case ICER: £", format(round(base_case_icer), big.mark = ",")),
x = "ICER (£/QALY)",
y = NULL
) +
theme_minimal()
}
# Create tornado diagram for one-way sensitivity analysis
plot_tornado <- function(dsa_results, base_case_icer, wtp = NULL) {
library(ggplot2)
# Calculate parameter ranges and order by impact
param_ranges <- aggregate(icer ~ parameter, data = dsa_results,
function(x) max(x, na.rm = TRUE) - min(x, na.rm = TRUE))
colnames(param_ranges)[2] <- "range"
param_ranges <- param_ranges[order(-param_ranges$range), ]
# Merge and set factor levels
plot_data <- merge(dsa_results, param_ranges, by = "parameter")
plot_data$parameter <- factor(plot_data$parameter, levels = rev(param_ranges$parameter))
# Create plot
ggplot(plot_data, aes(x = icer, y = parameter)) +
geom_line(aes(group = parameter), linewidth = 1.5, color = "steelblue") +
geom_point(aes(shape = bound), size = 3, color = "steelblue") +
geom_vline(xintercept = base_case_icer, linetype = "dashed") +
geom_vline(xintercept = wtp, linetype = "dotted", color = "red") +
scale_shape_manual(values = c("lower" = 16, "upper" = 17)) +
labs(
title = "Tornado Diagram: One-Way Sensitivity Analysis",
subtitle = paste0("Base case ICER: £", format(round(base_case_icer), big.mark = ",")),
x = "ICER (£/QALY)",
y = NULL
) +
theme_minimal()
}
runApp()
dsa_results$display_label <- dsa_results$description
runApp()
